<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ResQ 112 - Live Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
  <style>
    body{font-family:'Inter',sans-serif;background:#0a0a1a;color:#e0e0e0;overflow:hidden; height:100vh;}
    #ripple-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0}
    .content-overlay{position:relative;z-index:2;height:100%;background:radial-gradient(circle,rgba(10,10,26,0.85),#0a0a1a 90%);backdrop-filter:blur(4px); display: flex; flex-direction: column;}
    .glass-card{background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);padding:24px;border-radius:16px;}
    .glow-button{display:inline-block;padding:12px 24px;border-radius:8px;background:#00aaff;color:black;font-weight:600;text-align:center;transition:all .3s ease; border: 1px solid #00aaff; cursor: pointer;}
    .glow-button:hover{box-shadow:0 0 10px #00ffff,0 0 25px #00ffff; background: #00cfff; border-color: #00cfff;}
    .back-button{background:rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;}
    .back-button:hover{background:rgba(255,255,255,0.2); box-shadow:0 0 10px #ffffff,0 0 15px #ffffff;}
    #map { z-index: 5; /* Keep map controls above background canvas */ }
    /* New styles for the theme toggle */
    input:checked ~ .dot {
        transform: translateX(1.5rem); /* Move the dot for the toggle */
    }
  </style>
</head>
<body>
<canvas id="ripple-canvas"></canvas>
<div class="content-overlay">
  <header class="p-4 bg-black/30 flex justify-between items-center flex-shrink-0">
    <div class="flex items-center space-x-2">
      <img src="logo.png.png" alt="logo" class="h-10 w-10"/>
      <span class="text-2xl font-bold text-white">ResQ 112</span>
    </div>
    <select id="languageSwitcher" class="bg-black/50 text-white p-2 rounded">
      <option value="en">English</option>
      <option value="hi">हिन्दी</option>
      <option value="as">অসমীয়া</option>
    </select>
  </header>

  <main class="flex-grow flex flex-col md:flex-row gap-4 p-4 min-h-0">
    <div id="map" class="flex-grow h-full min-h-[300px] rounded-2xl border-2 border-cyan-500/20"></div>

    <div class="glass-card flex-shrink-0 md:w-80 flex flex-col gap-4">
      <h2 class="text-2xl font-bold text-cyan-300" data-i18n="title">Live Location Sharing</h2>
      <button id="trackBtn" class="glow-button" data-i18n="track_btn">Share My Location</button>

      <div class="p-3 rounded-lg bg-black/30">
        <label for="theme-toggle" class="flex justify-between items-center cursor-pointer">
            <span class="font-semibold" data-i18n="map_theme_label">Map Theme</span>
            <div class="relative">
                <input type="checkbox" id="theme-toggle" class="sr-only">
                <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform"></div>
            </div>
        </label>
      </div>

      <div id="coords" class="text-center p-3 rounded-lg bg-black/30 text-gray-300" data-i18n="status_waiting">Waiting for location...</div>
      <a href="dashboard.html" class="glow-button back-button mt-auto" data-i18n="back_btn">Back to Dashboard</a>
    </div>
  </main>
</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAzwiwp0ByoUkofWPJG1Ux8BY8ueCDwVjM",
      authDomain: "geo-fencing-202f9.firebaseapp.com",
      databaseURL: "https://geo-fencing-202f9-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "geo-fencing-202f9",
      storageBucket: "geo-fencing-202f9.firebasestorage.app",
      messagingSenderId: "815479242725",
      appId: "1:815479242725:web:0eaae779912a495b94f90c",
      measurementId: "G-WB7LFFPT4D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const touristId = "tourist_" + Math.floor(Math.random() * 100000);

    // == Leaflet map setup ==
    const map = L.map('map').setView([20.5937, 78.9629], 5);
    const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' });
    const lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
    darkLayer.addTo(map); // Start with dark theme by default

    let marker = null;
    let accuracyCircle = null;
    let watchId = null;
    const zoneGroup = L.featureGroup().addTo(map); // Layer group for geofence zones

    // == Translations Object ==
    const translations = {
      en: {
        title: "Live Location Sharing",
        track_btn: "Share My Location",
        stop_btn: "Stop Sharing",
        map_theme_label: "Map Theme",
        status_waiting: "Waiting for location...",
        status_starting: "Starting tracking...",
        status_stopped: "Tracking stopped.",
        back_btn: "Back to Dashboard"
      },
      hi: {
        title: "लाइव लोकेशन शेयरिंग",
        track_btn: "मेरी लोकेशन साझा करें",
        stop_btn: "शेयरिंग रोकें",
        map_theme_label: "मैप की थीम",
        status_waiting: "लोकेशन की प्रतीक्षा है...",
        status_starting: "ट्रैकिंग शुरू हो रही है...",
        status_stopped: "ट्रैकिंग रोक दी गई।",
        back_btn: "डैशबोर्ड पर वापस जाएं"
      },
      as: {
        title: "লাইভ অৱস্থান শ্বেয়াৰিং",
        track_btn: "মোৰ অৱস্থান শ্বেয়াৰ কৰক",
        stop_btn: "শ্বেয়াৰিং বন্ধ কৰক",
        map_theme_label: "মানচিত্ৰৰ থীম",
        status_waiting: "অৱস্থানৰ বাবে অপেক্ষা...",
        status_starting: "ট্ৰেকিং আৰম্ভ হৈছে...",
        status_stopped: "ট্ৰেকিং বন্ধ হ'ল।",
        back_btn: "ডেশ্বব’ৰ্ডলৈ ঘূৰি যাওক"
      }
    };
    
    const trackBtn = document.getElementById("trackBtn");
    const coordsDiv = document.getElementById("coords");
    const themeToggle = document.getElementById('theme-toggle');

    // == Theme Toggle Logic ==
    themeToggle.addEventListener('change', () => {
        if (themeToggle.checked) { // If toggled ON, switch to Light Theme
            map.removeLayer(darkLayer);
            lightLayer.addTo(map);
        } else { // If toggled OFF, switch to Dark Theme
            map.removeLayer(lightLayer);
            darkLayer.addTo(map);
        }
    });

    function startTracking() {
      const lang = localStorage.getItem("lang") || "en";
      if (!navigator.geolocation) {
        coordsDiv.textContent = "Geolocation not supported.";
        return;
      }

      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        trackBtn.textContent = translations[lang].track_btn;
        coordsDiv.textContent = translations[lang].status_stopped;
        return;
      }

      trackBtn.textContent = translations[lang].stop_btn;
      coordsDiv.textContent = translations[lang].status_starting;

      watchId = navigator.geolocation.watchPosition((position) => {
        const { latitude: lat, longitude: lng, accuracy: acc } = position.coords;

        set(ref(db, 'tourists/' + touristId), { latitude: lat, longitude: lng, accuracy: acc, timestamp: Date.now() });

        if (!marker) {
          marker = L.marker([lat, lng]).addTo(map);
        } else {
          marker.setLatLng([lat, lng]);
        }
        if (accuracyCircle) accuracyCircle.remove();
        accuracyCircle = L.circle([lat, lng], { radius: acc, color: "#00FFFF", fillColor: "#00FFFF", fillOpacity: 0.15 }).addTo(map);

        map.setView([lat, lng], 17);
        coordsDiv.textContent = `ID: ${touristId} | Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
      }, (err) => {
        coordsDiv.textContent = "Error: " + err.message;
      }, { enableHighAccuracy: true });
    }
    trackBtn.addEventListener('click', startTracking);

    // == Fetch and Display Geofence Zones ==
    onValue(ref(db, 'zones'), (snapshot) => {
        zoneGroup.clearLayers(); // Clear old zones before drawing new ones
        const zones = snapshot.val() || {};
        for (const zoneId in zones) {
            const z = zones[zoneId];
            let zoneLayer;
            const zoneStyle = { color: "#00ffff", weight: 2, opacity: 0.7, fillOpacity: 0.1 };
            
            if (z.type === 'circle') {
                zoneLayer = L.circle([z.center.lat, z.center.lng], { ...zoneStyle, radius: z.radius });
            } else if (z.type === 'polygon') {
                zoneLayer = L.polygon(z.points.map(p => [p.lat, p.lng]), zoneStyle);
            }

            if (zoneLayer) {
                zoneLayer.bindTooltip(`Zone ID: ${zoneId}`, { permanent: false, direction: 'center' });
                zoneGroup.addLayer(zoneLayer);
            }
        }
    });

    // == Language Switcher Logic ==
    const switcher = document.getElementById("languageSwitcher");
    function updateLanguage(lang) {
        localStorage.setItem("lang", lang);
        document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (translations[lang] && translations[lang][key]) {
                el.innerText = translations[lang][key];
            }
        });
        // Update button text if tracking is active/inactive
        if(watchId !== null) {
            trackBtn.textContent = translations[lang].stop_btn;
        } else {
            trackBtn.textContent = translations[lang].track_btn;
        }
    }
    switcher.addEventListener("change", e => updateLanguage(e.target.value));
    window.addEventListener("load", () => {
        const savedLang = localStorage.getItem("lang") || "en";
        switcher.value = savedLang;
        updateLanguage(savedLang);
    });
    
    window.addEventListener('beforeunload', () => {
      if (watchId !== null) navigator.geolocation.clearWatch(watchId);
    });

    // Ripple background effect
    const canvas=document.getElementById("ripple-canvas"),ctx=canvas.getContext("2d");
    canvas.width=innerWidth;canvas.height=innerHeight;
    let ripples=[];
    class Ripple{constructor(x,y){this.x=x;this.y=y;this.radius=0;this.alpha=1;}
    update(){this.radius+=1.5;this.alpha-=0.01;}
    draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,2*Math.PI);ctx.strokeStyle=`rgba(0,255,255,${this.alpha})`;ctx.stroke();}}
    function animate(){ctx.clearRect(0,0,canvas.width,canvas.height);
    ripples.forEach((r,i)=>{r.update();r.draw();if(r.alpha<=0)ripples.splice(i,1);});
    requestAnimationFrame(animate);}
    animate();
    addEventListener("mousemove",e=>ripples.push(new Ripple(e.clientX,e.clientY)));
  </script>
</body>
</html>